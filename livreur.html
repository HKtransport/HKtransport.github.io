<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Espace Livreur ‚Äì Baba Colis</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background:#f5f5f5;
        padding:20px;
    }
    h1 {
        text-align:center;
        color:#008000;
    }
    #reader {
        width:300px;
        margin:20px auto;
    }
    input, select, textarea {
        width:100%;
        padding:12px;
        margin-top:10px;
        border-radius:8px;
        border:1px solid #ccc;
    }
    button {
        width:100%;
        padding:12px;
        margin-top:15px;
        background:#008000;
        color:white;
        border:none;
        border-radius:8px;
        cursor:pointer;
        font-size:16px;
    }
    button:hover {
        background:#006600;
    }
    .logout {
        background:#d9534f !important;
    }
</style>
</head>

<body>

<script>
if (localStorage.getItem("livreur") !== "ok") {
    window.location.href = "livreur-password-login.html";
}
</script>

<h1>Espace Livreur ‚Äì Baba Colis</h1>

<button class="logout" onclick="logout()">D√©connexion</button>

<div id="reader"></div>

<input type="text" id="numero" placeholder="Num√©ro du colis (scan)">
<select id="statut">
    <option value="En livraison">En livraison</option>
    <option value="Livr√©">Livr√©</option>
</select>

<input type="text" id="localisation" placeholder="Localisation (auto)">
<button onclick="getLocation()">üìç Localisation automatique</button>

<textarea id="historique" placeholder="Note livreur (optionnel)"></textarea>

<button onclick="updateColis()">Mettre √† jour</button>

<script>
function logout() {
    localStorage.removeItem("livreur");
    localStorage.removeItem("livreur_id");
    localStorage.removeItem("livreur_nom");
    window.location.href = "livreur-password-login.html";
}

function onScanSuccess(decodedText) {
    document.getElementById("numero").value = decodedText;
}

new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 })
    .render(onScanSuccess);

function getLocation() {
    if (!navigator.geolocation) {
        alert("La g√©olocalisation n'est pas support√©e par ce t√©l√©phone.");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude.toFixed(5);
            const lon = pos.coords.longitude.toFixed(5);
            document.getElementById("localisation").value = `${lat}, ${lon}`;
        },
        () => {
            alert("Impossible d'obtenir la localisation.");
        }
    );
}

function updateColis() {
    const numero = document.getElementById("numero").value;
    const statut = document.getElementById("statut").value;
    const localisation = document.getElementById("localisation").value;
    const historique = document.getElementById("historique").value;
    const livreurNom = localStorage.getItem("livreur_nom") || "";

    if (numero.trim() === "") {
        alert("Scanne un colis d'abord.");
        return;
    }

    fetch("https://babacolis.wuaze.com/update_colis.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            numero: numero,
            statut: statut,
            localisation: localisation,
            historique: historique !== "" ? (`[${livreurNom}] ` + historique) : ""
        })
    })
    .then(res => res.json())
    .then(() => {
        alert("Colis mis √† jour avec succ√®s !");
        document.getElementById("historique").value = "";
    });
}
</script>

</body>
</html>
